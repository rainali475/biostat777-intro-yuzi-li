{
  "hash": "cc956a9afbe7adfe6090657d9733fcb1",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Example Analysis\"\nbibliography: refs.bib\n---\n\n\n\n\n## Question\n\nFind out what kidney cortex genes are differentially expressed between biological sex groups.\n\n## Intended Audience\n\nThe scientific community or researchers interested in sex-related differences in gene expression in kidney cortex. \n\n## Data source\n\nData is obtained from recount3 R package [@recount3], and the original data source is GTEx [@gtex]. \n\n::: {.column-margin}\n![GTEx](gtex.png)\n:::\n\nRecount3 study explorer: <https://rna.recount.bio/>\nRecount3 R package: <https://bioconductor.org/packages/release/bioc/html/recount3.html>\nGTEx: <https://gtexportal.org/home/>\n\n### Data dictionary \n\nThe GTEx kidney study contains 98 samples coming from 96 subjects. The gene expression matrix contains 63856 ENSEMBL genes for each sample. Each sample is associated with sme metadata, and the data dictionary for the metadata is included below. \n\n| Term | Description |\n|------|-------------|\n| gtex.sampid | GTEx sample ID. This is unique for each sample. The format is GTEX-[donor ID]-[tissue site ID]-SM-[aliquot ID]. |\n| gtex.subjid | Subject ID. |\n| gtex.age | Age of subject divided into age groups: 20-29, 30-39, 40-49, 50-59, 60-69, 70-79 |\n| gtex.sex | Biological sex of subject. 1 represents male, and 2 represents female. |\n| gtex.smtsd | The accurate site of sample. For kidney study, this includes \"Kidney - Cortex\" and \"Kidney - Medulla\". |\n\n: Dictionary for metadata\n\n## Data analysis\n\n\n\n\n\n\n\n\n\n### Get data and metadata\n\nFirst, get metadata from recount3. \n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmetadata <- data.frame(rse@colData@listData)\nmetadata <- metadata %>% select(gtex.sampid, \n                                gtex.subjid, \n                                gtex.age, \n                                gtex.sex, \n                                gtex.smtsd)\nhead(metadata)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n               gtex.sampid gtex.subjid gtex.age gtex.sex      gtex.smtsd\n1 GTEX-14E6D-2526-SM-5YYA9  GTEX-14E6D    50-59        1 Kidney - Cortex\n2 GTEX-17F96-1926-SM-7MGWY  GTEX-17F96    70-79        1 Kidney - Cortex\n3 GTEX-1JMPZ-1226-SM-ARU8Y  GTEX-1JMPZ    30-39        1 Kidney - Cortex\n4 GTEX-12WSG-0826-SM-5EQ5A  GTEX-12WSG    50-59        2 Kidney - Cortex\n5  GTEX-ZE9C-1426-SM-4WKGM   GTEX-ZE9C    60-69        1 Kidney - Cortex\n6 GTEX-147F4-2626-SM-5Q5CS  GTEX-147F4    50-59        1 Kidney - Cortex\n```\n\n\n:::\n\n```{.r .cell-code}\nnrow(metadata %>% distinct(gtex.subjid))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 96\n```\n\n\n:::\n\n```{.r .cell-code}\nmetadata %>% count(gtex.age)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  gtex.age  n\n1    20-29  5\n2    30-39  9\n3    40-49  9\n4    50-59 34\n5    60-69 37\n6    70-79  4\n```\n\n\n:::\n\n```{.r .cell-code}\nmetadata %>% count(gtex.sex)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  gtex.sex  n\n1        1 76\n2        2 22\n```\n\n\n:::\n\n```{.r .cell-code}\nmetadata %>% count(gtex.smtsd)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n        gtex.smtsd  n\n1  Kidney - Cortex 94\n2 Kidney - Medulla  4\n```\n\n\n:::\n:::\n\n\n\n\nGet gene expression data for GTEx kidney study from recount3. In the FPKM matrix, each row is a gene and each column is a sample. \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Get FPKM from raw counts\ndeseq_obj <- DESeqDataSet(rse, design = ~ as.factor(c(\"study\", \"external_id\")))\nfpkm_matrix <- DESeq2::fpkm(deseq_obj)\n```\n:::\n\n\n\n\n### Process data\n\nChange sex values in metadata to male and female. \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmetadata <- metadata %>% mutate_at(vars(gtex.sex), recode, \n                                   \"1\" = \"male\", \"2\" = \"female\")\n```\n:::\n\n\n\n\nMatch FPKM matrix column names with sample IDs, exclude medulla samples, and exclude duplicate samples from same subject.\n\n::: {.callout-note}\nNote that there are only 4 medulla samples, so excluding them would not largely reduce the number of samples. \n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncolnames(fpkm_matrix) <- gsub(\"\\\\.1\", \"\", colnames(fpkm_matrix))\nmetadata <- metadata %>% filter(gtex.smtsd == \"Kidney - Cortex\") %>% \n  distinct(gtex.subjid, .keep_all = TRUE)\nfpkm_matrix <- fpkm_matrix[, metadata$gtex.sampid]\nncol(fpkm_matrix)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 93\n```\n\n\n:::\n:::\n\n\n\n\nRemove zero-variance genes.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfpkm_matrix <- fpkm_matrix[rowVars(fpkm_matrix) > 0, ]\nnrow(fpkm_matrix)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 53798\n```\n\n\n:::\n:::\n\n\n\n\nFit GAM model to log mean and log variance of expression, then keep only the top 5000 genes with high residual variance. \n\n::: {.callout-tip}\nHere, we filter genes with mean-adjusted variance instead of variance because genes that are highly expressed often have more variance in expression than genes that have low expression. \n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngene_mean <- rowMeans(fpkm_matrix)\ngene_var <- rowVars(fpkm_matrix)\nmean_var_df <- data.frame(X=gene_mean,Y=gene_var)\ngam_model <- gam(formula = log2(x=Y) ~ s(log2(x=X)), data = mean_var_df)\ngene_sd_expect <- sqrt(2^(gam_model$fitted.values))\ngene_var_norm <- (fpkm_matrix - gene_mean)/gene_sd_expect\ngene_hyper_var <- rowSums(gene_var_norm^2)/(ncol(fpkm_matrix) - 1)\n\nfpkm_matrix <- fpkm_matrix[order(gene_hyper_var)[1:5000], ]\n```\n:::\n\n\n\n\nCheck average log gene expression in female and male. \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfm_avg <- rowMeans(log(fpkm_matrix[, metadata$gtex.sex == \"female\"] + 1))\nm_avg <- rowMeans(log(fpkm_matrix[, metadata$gtex.sex == \"male\"] + 1))\nexpr_avg <- data.frame(expression = c(m_avg, fm_avg), \n                       sex = as.factor(rep(c(\"male\", \"female\"), \n                                           each = nrow(fpkm_matrix))))\ng <- ggplot(expr_avg, aes(expression)) + geom_histogram() + facet_wrap(vars(sex))\ng <- g + labs(title = \"Mean expression comparison between sex\", \n              subtitle = \"Mean log FPKM in female and male kidneys\", \n              caption = \"Data source: GTEx\")\ng\n```\n\n::: {.cell-output-display}\n![](example_analysis_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n\n\n### PCA\n\nUse PCA to explore gene expression data [@PCA]. \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npca_res <- prcomp(t(fpkm_matrix), scale. = TRUE)\ntop_pcs <- data.frame(pca_res$x)\ng <- ggplot(data = top_pcs, \n            mapping = aes(PC1, PC2, colour = as.factor(metadata$gtex.sex))) +\n  geom_point()\ng$labels$colour <- \"Sex\"\ng <- g + labs(colour = \"Sex\", \n              title = \"PCA plot\", \n              subtitle = \"Top two PCs of PCA on kidney samples gene expression\", \n              caption = \"Data source: GTEx\")\ng\n```\n\n::: {.cell-output-display}\n![](example_analysis_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nexplained_var <- data.frame(t(summary(pca_res)$importance))\nexplained_var <- explained_var[1:10, ]\nvar_plot <- ggplot(data = explained_var, \n                   mapping = aes(factor(rownames(explained_var), \n                                        levels = rownames(explained_var)), \n                                 explained_var$Proportion.of.Variance, group=1))\nvar_plot <- var_plot + geom_line() + geom_point()\nvar_plot <- var_plot + labs(x = \"Principal Components\", \n                            y = \"Proportion of Variance Explained\", \n                            title = \"PCA exaplained variance\", \n                            subtitle = \"Proportions of variance explained by top 10 PCs\", \n                            caption = \"Based on GTEx kidney RNA-seq study\")\nvar_plot <- var_plot + geom_text(aes(label=explained_var$Proportion.of.Variance),\n                                 vjust=-0.25)\nvar_plot\n```\n\n::: {.cell-output-display}\n![](example_analysis_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n\n\n\nThere is no clear separation of female and male subjects kidney gene expression from the top PCs. \n\n### Differential expression analysis\n\nUse Wilcoxon rank sum test to compare female and male expression of each gene in kidney.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngroups <- metadata$gtex.sex\nnames(groups) <- metadata$gtex.sampid\n\nres <- t(apply(fpkm_matrix, 1, function(i) {\n  tmptest <- wilcox.test(i[groups==\"male\"],\n                         i[groups==\"female\"],\n                         alternative = \"two.sided\",\n                         var.equal = T)\n  c(tmptest$statistic, tmptest$p.value)\n}))\nFDR <- p.adjust(res[,2],method=\"fdr\")\ndiff_logfc <- rowMeans(log2(fpkm_matrix[, groups == \"female\"] + 1)) - \n  rowMeans(log2(fpkm_matrix[, groups == \"male\"] + 1))\ndiff_res <- data.frame(statistics = res[,1],\n                       pvalue = res[,2],\n                       FDR = FDR,\n                       logFC = diff_logfc, \n                       stringsAsFactors = F)\ndiff_res[order(diff_res$FDR)[1:10],]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                   statistics       pvalue          FDR        logFC\nENSG00000241859.6      1512.0 3.021754e-12 5.532180e-09 -0.002954730\nENSG00000251510.1      1501.5 5.532180e-12 5.532180e-09 -0.004263487\nENSG00000231535.5      1512.0 2.905205e-12 5.532180e-09 -0.008388644\nENSG00000092377.13     1501.5 5.532180e-12 5.532180e-09 -0.005932648\nENSG00000165246.13     1512.0 3.712517e-12 5.532180e-09 -0.013881424\nENSG00000229236.1      1494.0 9.726915e-12 7.442389e-09 -0.006092837\nENSG00000225117.1      1491.0 1.041934e-11 7.442389e-09 -0.006967552\nENSG00000225012.5      1480.5 1.941076e-11 1.213172e-08 -0.002876795\nENSG00000147050.14       38.0 4.314840e-11 2.397133e-08  0.047093209\nENSG00000229308.1      1464.0 5.473275e-11 2.736638e-08 -0.002405182\n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(diff_logfc)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n      Min.    1st Qu.     Median       Mean    3rd Qu.       Max. \n-2.648e-01 -1.379e-03 -7.197e-05 -8.789e-04  6.401e-04  9.640e-02 \n```\n\n\n:::\n:::\n\n\n\n\nThe significant FDR values show that there are sex-related differences in kidney gene expression, but the small log fold change suggests that the differences are slight in terms of difference in amount of genes expressed.\n\n### Functions used\n\n#### dplyr\n\nselect, count, distinct, filter, pull\n\n#### ggplot2\n\ngeom_histogram, geom_point, geom_line\n\n## Summary\n\nIn this project, we examine the sex-related difference in kidney cortex gene expression profiles. We see that in GTEx kidney cortex RNA-seq data, male and female gene expression cannot be separated well by PCA. Using Wilcoxon rank sum test on each gene, we see that there are sex-related differential gene expression in kidney indicated by the small adjusted p-values. However, the amount of change in expression is small. In conclusion, there are differences in gene expression profiles of male and female kidneys, but these differences are not huge in magnitude.",
    "supporting": [
      "example_analysis_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}